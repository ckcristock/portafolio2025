<div class="p-6">
  <div class="mb-6">
    <a
      routerLink="/clients"
      class="inline-flex items-center text-blue-600 hover:underline font-semibold"
    >
      <i class="fas fa-arrow-left mr-2"></i>
      Volver al listado de clientes
    </a>
  </div>

  <div *ngIf="client" class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">
      Historial de Fórmulas de {{ client.nombre }} {{ client.apellido }}
    </h1>
    <p class="text-gray-600">Documento: {{ client.documento_identidad }}</p>
  </div>

  <div *ngIf="prescriptions.length > 0; else noPrescriptions">
    <div
      *ngFor="let p of prescriptions"
      class="bg-white p-6 rounded-lg shadow-md mb-6"
    >
      <div class="flex justify-between items-baseline mb-4">
        <h2 class="font-bold text-xl text-gray-700">
          Fecha de la Consulta: {{ p.fecha | date : "dd / MMMM / yyyy" }}
        </h2>
        <span class="text-sm text-gray-500"
          >ID Fórmula: {{ p.id_formula }}</span
        >
      </div>

      <!-- ... (El grid con los datos de la fórmula sigue igual) ... -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-8 gap-y-4 mb-4">
        <!-- OD -->
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD ESFERA</div>
          <div class="text-lg font-mono">
            {{ p.od_esfera | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD CILINDRO</div>
          <div class="text-lg font-mono">
            {{ p.od_cilindro | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD EJE</div>
          <div class="text-lg font-mono">{{ p.od_eje }}°</div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">ADICIÓN</div>
          <div class="text-lg font-mono">
            {{ p.adicion | number : "1.2-2" }}
          </div>
        </div>
        <!-- OI -->
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI ESFERA</div>
          <div class="text-lg font-mono text-blue-900">
            {{ p.oi_esfera | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI CILINDRO</div>
          <div class="text-lg font-mono text-blue-900">
            {{ p.oi_cilindro | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI EJE</div>
          <div class="text-lg font-mono text-blue-900">{{ p.oi_eje }}°</div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">DP</div>
          <div class="text-lg font-mono text-blue-900">{{ p.dp }} mm</div>
        </div>
      </div>

      <div *ngIf="p.observaciones" class="mt-4">
        <h4 class="font-semibold text-sm text-gray-600">Observaciones:</h4>
        <p
          class="text-gray-800 bg-yellow-50 p-3 rounded-md border border-yellow-200"
        >
          {{ p.observaciones }}
        </p>
      </div>

      <!-- BOTÓN PARA VER LA IMAGEN -->
      <div *ngIf="p.imageUrl" class="mt-6 border-t pt-4">
        <button
          (click)="showImage(p.imageUrl)"
          class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <i class="fas fa-image mr-2"></i>
          Ver Imagen de la Fórmula
        </button>
      </div>
    </div>
  </div>

  <ng-template #noPrescriptions>
    <div class="text-center py-10 px-6 bg-white rounded-lg shadow-md">
      <p class="text-gray-500">
        Este cliente aún no tiene fórmulas optométricas registradas.
      </p>
    </div>
  </ng-template>
</div>

<!-- MODAL PARA MOSTRAR LA IMAGEN -->
<div
  *ngIf="selectedImageUrl"
  (click)="closeImageModal()"
  class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
>
  <div class="relative" (click)="$event.stopPropagation()">
    <img
      [src]="selectedImageUrl"
      alt="Fórmula Optométrica Escaneada"
      class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"
    />
    <button
      (click)="closeImageModal()"
      class="absolute -top-4 -right-4 bg-white text-black rounded-full h-10 w-10 flex items-center justify-center text-xl font-bold focus:outline-none shadow-lg"
    >
      &times;
    </button>
  </div>
</div>

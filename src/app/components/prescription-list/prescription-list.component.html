<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <a
        routerLink="/clients"
        class="inline-flex items-center text-blue-600 hover:underline font-semibold"
      >
        <i class="fas fa-arrow-left mr-2"></i>
        Volver
      </a>
      <div *ngIf="client" class="mt-2">
        <h1 class="text-3xl font-bold text-gray-800">
          Historial de {{ client.nombre }} {{ client.apellido }}
        </h1>
        <p class="text-gray-600">Documento: {{ client.documento_identidad }}</p>
      </div>
    </div>
    <button
      (click)="openAddForm()"
      class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md"
    >
      &#43; Agregar Nueva Fórmula
    </button>
  </div>

  <!-- Contenido principal: lista de fórmulas -->
  <div *ngIf="prescriptions.length > 0; else noPrescriptions">
    <div
      *ngFor="let p of prescriptions"
      class="bg-white p-6 rounded-lg shadow-md mb-6"
    >
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="font-bold text-xl text-gray-700">
            Fecha: {{ p.fecha | date : "dd / MMMM / yyyy" }}
          </h2>
          <span class="text-sm text-gray-500"
            >ID Fórmula: {{ p.id_formula }}</span
          >
        </div>
        <div>
          <button
            (click)="openEditForm(p)"
            class="text-yellow-600 hover:text-yellow-800 text-sm font-semibold mr-4"
          >
            Editar
          </button>
          <button
            (click)="deletePrescription(p.id_formula)"
            class="text-red-600 hover:text-red-800 text-sm font-semibold"
          >
            Eliminar
          </button>
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-8 gap-y-4 mb-4">
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD ESFERA</div>
          <div class="text-lg font-mono">
            {{ p.od_esfera | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD CILINDRO</div>
          <div class="text-lg font-mono">
            {{ p.od_cilindro | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">OD EJE</div>
          <div class="text-lg font-mono">{{ p.od_eje }}°</div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="text-xs font-bold text-gray-500">ADICIÓN</div>
          <div class="text-lg font-mono">
            {{ p.adicion | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI ESFERA</div>
          <div class="text-lg font-mono text-blue-900">
            {{ p.oi_esfera | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI CILINDRO</div>
          <div class="text-lg font-mono text-blue-900">
            {{ p.oi_cilindro | number : "1.2-2" }}
          </div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">OI EJE</div>
          <div class="text-lg font-mono text-blue-900">{{ p.oi_eje }}°</div>
        </div>
        <div class="text-center p-2 bg-blue-50 rounded">
          <div class="text-xs font-bold text-blue-800">DP</div>
          <div class="text-lg font-mono text-blue-900">{{ p.dp }} mm</div>
        </div>
      </div>
      <div *ngIf="p.observaciones" class="mt-4">
        <h4 class="font-semibold text-sm text-gray-600">Observaciones:</h4>
        <p
          class="text-gray-800 bg-yellow-50 p-3 rounded-md border border-yellow-200"
        >
          {{ p.observaciones }}
        </p>
      </div>
      <div *ngIf="p.imageUrl" class="mt-6 border-t pt-4">
        <button
          (click)="showImage(p.imageUrl)"
          class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700"
        >
          <i class="fas fa-image mr-2"></i>Ver Imagen de la Fórmula
        </button>
      </div>
    </div>
  </div>
  <ng-template #noPrescriptions>
    <div class="text-center py-10 px-6 bg-white rounded-lg shadow-md">
      <p class="text-gray-500">
        Este cliente aún no tiene fórmulas optométricas registradas.
      </p>
    </div>
  </ng-template>
</div>

<!-- FORMULARIO MODAL PARA AGREGAR/EDITAR FÓRMULA -->
<div
  *ngIf="showForm"
  class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
>
  <div
    class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto"
  >
    <h3 class="text-2xl font-bold mb-6">
      {{ isEditing ? "Editar Fórmula Optométrica" : "Agregar Nueva Fórmula" }}
    </h3>
    <form (ngSubmit)="savePrescription()" #prescriptionForm="ngForm">
      <!-- Sección de Datos Generales -->
      <fieldset class="mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Fecha de la Fórmula</label
            >
            <input
              type="date"
              [(ngModel)]="currentPrescription.fecha"
              name="fecha"
              required
              class="mt-1 p-2 border rounded-md w-full"
            />
          </div>
          <div>
            <!-- AÑADIDO: Campo para subir la imagen -->
            <label class="block text-sm font-medium text-gray-700"
              >Subir Imagen de la Fórmula</label
            >
            <input
              type="file"
              (change)="onFileSelected($event)"
              accept="image/*"
              class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
          </div>
        </div>
      </fieldset>

      <!-- Sección de Graduación -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
        <!-- Columna Ojo Izquierdo -->
        <fieldset class="border rounded-md p-4">
          <legend class="text-lg font-semibold text-blue-800 px-2">
            Ojo Izquierdo (OI)
          </legend>
          <div class="space-y-4 mt-2">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Esfera</label
              >
              <input
                type="number"
                step="0.01"
                [(ngModel)]="currentPrescription.oi_esfera"
                name="oi_esfera"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Cilindro</label
              >
              <input
                type="number"
                step="0.01"
                [(ngModel)]="currentPrescription.oi_cilindro"
                name="oi_cilindro"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Eje</label>
              <input
                type="number"
                [(ngModel)]="currentPrescription.oi_eje"
                name="oi_eje"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
          </div>
        </fieldset>
        <!-- Columna Ojo Derecho -->
        <fieldset class="border rounded-md p-4">
          <legend class="text-lg font-semibold text-gray-800 px-2">
            Ojo Derecho (OD)
          </legend>
          <div class="space-y-4 mt-2">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Esfera</label
              >
              <input
                type="number"
                step="0.01"
                [(ngModel)]="currentPrescription.od_esfera"
                name="od_esfera"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Cilindro</label
              >
              <input
                type="number"
                step="0.01"
                [(ngModel)]="currentPrescription.od_cilindro"
                name="od_cilindro"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Eje</label>
              <input
                type="number"
                [(ngModel)]="currentPrescription.od_eje"
                name="od_eje"
                required
                class="mt-1 p-2 border rounded-md w-full"
              />
            </div>
          </div>
        </fieldset>
      </div>

      <!-- Sección Adicional -->
      <fieldset class="border rounded-md p-4 mt-6">
        <legend class="text-lg font-semibold text-gray-800 px-2">
          Valores Adicionales
        </legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Adición</label
            >
            <input
              type="number"
              step="0.01"
              [(ngModel)]="currentPrescription.adicion"
              name="adicion"
              required
              class="mt-1 p-2 border rounded-md w-full"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Distancia Pupilar (DP)</label
            >
            <input
              type="number"
              step="0.1"
              [(ngModel)]="currentPrescription.dp"
              name="dp"
              required
              class="mt-1 p-2 border rounded-md w-full"
            />
          </div>
        </div>
      </fieldset>

      <!-- Observaciones -->
      <div class="mt-6">
        <label class="block text-sm font-medium text-gray-700"
          >Observaciones</label
        >
        <textarea
          [(ngModel)]="currentPrescription.observaciones"
          name="observaciones"
          class="mt-1 p-2 border rounded-md w-full"
          rows="3"
        ></textarea>
      </div>

      <div class="flex justify-end mt-8">
        <button
          type="button"
          (click)="closeForm()"
          class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2"
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="!prescriptionForm.form.valid"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50"
        >
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para ver imagen (sin cambios) -->
<div
  *ngIf="selectedImageUrl"
  (click)="closeImageModal()"
  class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
>
  <div class="relative" (click)="$event.stopPropagation()">
    <img
      [src]="selectedImageUrl"
      alt="Fórmula Escaneada"
      class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"
    /><button
      (click)="closeImageModal()"
      class="absolute -top-4 -right-4 bg-white text-black rounded-full h-10 w-10 flex items-center justify-center text-xl font-bold"
    >
      &times;
    </button>
  </div>
</div>
